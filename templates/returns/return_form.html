{% extends "../base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
 {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
<div class="py-5">
  <div class="row justify-content-center">
    <div class="col-md-11">
      <div class="card shadow-4">

        <div class="card-header bg-primary text-white text-center">
          <h4 class="mb-0">üîÅ {% if form.instance.pk %}Return ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®{% else %}‡¶®‡¶§‡ßÅ‡¶® Return ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®{% endif %}</h4>
        </div>

        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            {{ form.non_field_errors }}

            <div class="row mb-4">
              <div class="col-md-4">
                <label for="{{ form.return_type.id_for_label }}" class="form-label fw-semibold">Return Type</label>
                {{ form.return_type|add_class:"form-control" }}
                {% if form.return_type.errors %}
                  <div class="text-danger small mt-1">{{ form.return_type.errors.0 }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                <label for="{{ form.reference_id.id_for_label }}" class="form-label fw-semibold">Reference ID</label>
                {{ form.reference_id|add_class:"form-control" }}
                {% if form.reference_id.errors %}
                  <div class="text-danger small mt-1">{{ form.reference_id.errors.0 }}</div>
                {% endif %}
              </div>

              <div class="col-md-4">
                    <label for="{{ form.reason.id_for_label }}" class="form-label fw-semibold">‡¶ï‡¶æ‡¶∞‡¶£</label>
                    {{ form.reason|add_class:"form-control"|attr:"rows:2" }}
                    {% if form.reason.errors %}
                        <div class="text-danger small mt-1">{{ form.reason.errors.0 }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="form-check mb-4">
              {{ form.is_damaged|add_class:"form-check-input" }}
              <label class="form-check-label fw-semibold" for="{{ form.is_damaged.id_for_label }}">Damaged?</label>
              {% if form.is_damaged.errors %}
                <div class="text-danger small mt-1">{{ form.is_damaged.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="mb-4">
              <label for="{{ form.note.id_for_label }}" class="form-label fw-semibold">Note</label>
              {{ form.note|add_class:"form-control" }}
              {% if form.note.errors %}
                <div class="text-danger small mt-1">{{ form.note.errors.0 }}</div>
              {% endif %}
            </div>

            <hr>
            <h5 class="fw-semibold">üõí Return Items</h5>
            {{ items.management_form }}

            <div class="table-responsive">
              <table class="table table-bordered align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total Price</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>
                  {% for form in items.forms %}
                  <tr>
                    <td>
                      {{ form.product|add_class:"form-select" }}
                      {{ form.product.errors }}
                    </td>
                    <td>
                      {{ form.quantity|add_class:"form-control" }}
                      {{ form.quantity.errors }}
                    </td>
                    <td>
                      <input type="number" step="0.01" name="{{ form.prefix }}-unit_price"
                             class="form-control unit-price"
                             value="{{ form.initial.unit_price|default_if_none:'' }}">
                      {{ form.unit_price.errors }}
                    </td>
                    <td>
                      <input type="text" readonly class="form-control total-price" />
                    </td>
                    <td>
                      {% if form.instance.pk %}
                        {{ form.DELETE }}
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="text-end mb-4">
              <label class="fw-semibold me-2">Total Return Amount:</label>
              <input type="text" id="total_return_price" class="form-control d-inline-block w-auto" readonly />
            </div>

            <div class="text-center d-flex justify-content-center gap-3">
              <button type="submit" class="btn btn-success btn-rounded px-5">
                üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
              </button>
              <a href="{% url 'returns:return_list' %}" class="btn btn-secondary btn-rounded px-4">
                ‚Ü©Ô∏è ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®
              </a>
            </div>

          </form>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const returnTypeInput = document.getElementById('id_return_type');
    const refIdInput = document.getElementById('id_reference_id');

    // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡ßã ‡¶è‡¶∞ Total Price ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
    function calculateRowTotal(row) {
        const qtyInput = row.querySelector('input[id$=quantity]');
        const unitPriceInput = row.querySelector('input.unit-price');
        const totalPriceInput = row.querySelector('input.total-price');

        const qty = parseFloat(qtyInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;

        const total = qty * unitPrice;
        totalPriceInput.value = total.toFixed(2);

        return total;
    }

    // ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®: ‡¶∏‡¶¨ ‡¶∞‡ßã ‡¶è‡¶∞ Total Price ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ Total Return Price ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
    function calculateTotalReturnPrice() {
        let totalReturn = 0;
        document.querySelectorAll('input.total-price').forEach(function(input) {
            totalReturn += parseFloat(input.value) || 0;
        });
        document.getElementById('total_return_price').value = totalReturn.toFixed(2);
    }

    // ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá AJAX ‡¶¶‡¶ø‡ßü‡ßá ‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ ‡¶Ü‡¶®‡¶¨‡ßá
    document.querySelectorAll('select[id$=product]').forEach(function (productSelect) {
        productSelect.addEventListener('change', function () {
            const productId = this.value;
            const refId = refIdInput.value;
            const returnType = returnTypeInput.value;
            const row = this.closest('tr');

            if (productId && refId && returnType) {
                fetch(`/returns/ajax/get-unit-price/?product_id=${productId}&ref_id=${refId}&type=${returnType}`)
                    .then(response => response.json())
                    .then(data => {
                        const unitPriceInput = row.querySelector('input.unit-price');
                        if (unitPriceInput && data.unit_price !== null) {
                            unitPriceInput.value = data.unit_price;
                        } else {
                            unitPriceInput.value = '';
                        }
                        calculateRowTotal(row);
                        calculateTotalReturnPrice();
                    });
            }
        });
    });

    // Quantity ‡¶¨‡¶æ Unit Price ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá ‡¶∞‡ßã ‡¶è‡¶∞ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
    document.querySelectorAll('input[id$=quantity]').forEach(function(qtyInput) {
        qtyInput.addEventListener('input', function () {
            const row = this.closest('tr');
            calculateRowTotal(row);
            calculateTotalReturnPrice();
        });
    });

    document.querySelectorAll('input.unit-price').forEach(function(unitPriceInput) {
        unitPriceInput.addEventListener('input', function () {
            const row = this.closest('tr');
            calculateRowTotal(row);
            calculateTotalReturnPrice();
        });
    });

    // ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶°‡ßá ‡¶∏‡¶¨ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ü‡ßã‡¶ü‡¶æ‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßã
    document.querySelectorAll('tbody tr').forEach(function(row) {
        calculateRowTotal(row);
    });
    calculateTotalReturnPrice();
});
</script>
{% endblock %}
